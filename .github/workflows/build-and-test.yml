name: Build

on: 
  push:
    paths:
      - '**.toml'
      - '**.py'
      - '**.cpp'
      - '**.h'
      - '**.c'
      - 'xmake.lua'
      - 'CMakeLists.txt'
      - '*.yml'
  pull_request:
    paths:
      - '**.toml'
      - '**.py'
      - '**.cpp'
      - '**.h'
      - '**.c'
      - 'xmake.lua'
      - 'CMakeLists.txt'
      - '*.yml'
  workflow_call:
  workflow_dispatch:
    inputs:
      os:
        description: "Which OS to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - windows
          - ubuntu

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v5

      - name: Set cibuildwheel cache dir
        shell: bash
        run: echo "CIBW_CACHE_PATH=${GITHUB_WORKSPACE}/.cibw-cache" >> "$GITHUB_ENV"

      - name: Cache cibuildwheel tools
        uses: actions/cache@v4
        with:
          path: ${{ env.CIBW_CACHE_PATH }}
          key: cibw-${{ runner.os }}-${{ hashFiles('pyproject.toml', 'CMakeLists.txt', 'xmake.lua', '**/*.toml') }}
          restore-keys: |
            cibw-${{ runner.os }}-

      - name: Cache CPM downloads
        uses: actions/cache@v4
        with:
          path: ~/cpm-cache
          key: cpm-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', '**/CPM*.cmake') }}
          restore-keys: |
            ${{ runner.os }}-cpm-

      - uses: TheMrMilchmann/setup-msvc-dev@v4
        if: runner.os == 'Windows'
        with:
          arch: x64
  
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_CACHE_PATH: ${{ env.CIBW_CACHE_PATH }}

      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl
          retention-days: 7
